# name: test/sql/filter_movetext_annotations.test
# description: Test filter_movetext_annotations function (Spec: annotation-filtering)
# group: [filter_movetext_annotations]

require duckdb_chess

# Test single annotation removal (Spec: Movetext Annotation Removal - Remove single annotation)
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4 { comment } e5');
----
1. e4 e5

# Test multiple annotations removal (Spec: Movetext Annotation Removal - Remove multiple annotations)
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4 { first } e5 { second } 2. Nf3 { third }');
----
1. e4 e5 2. Nf3

# Test movetext without annotations (Spec: Movetext Annotation Removal - Preserve movetext without annotations)
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4 e5 2. Nf3 Nc6');
----
1. e4 e5 2. Nf3 Nc6

# Test nested annotations (Spec: Nested Annotation Handling - Nested braces)
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4 { outer { inner } text } e5');
----
1. e4 e5

# Test whitespace normalization (Spec: Whitespace Normalization - Remove extra spaces)
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4  { comment }  e5   { another }  2. Nf3');
----
1. e4 e5 2. Nf3

# Test empty string input (Spec: Single Row Output - Empty input handling)
query I
SELECT filtered_movetext FROM filter_movetext_annotations('');
----
(empty)

# Test complex annotation with multiple levels
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. d4 { [%eval 0.25] } d5 { [%clk 1:30:00] } 2. c4 { best move } e6');
----
1. d4 d5 2. c4 e6

# Test annotation at start
query I
SELECT filtered_movetext FROM filter_movetext_annotations('{ opening comment } 1. e4 e5');
----
1. e4 e5

# Test annotation at end
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4 e5 { game ends }');
----
1. e4 e5

# Test move structure preservation (Spec: Move Structure Preservation)
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4 { pawn } e5 { pawn } 2. Nf3+ { check } Nc6');
----
1. e4 e5 2. Nf3+ Nc6

# Test that result markers are preserved
query I
SELECT filtered_movetext FROM filter_movetext_annotations('1. e4 e5 2. Qh5 Nc6 3. Qxf7# { checkmate } 1-0');
----
1. e4 e5 2. Qh5 Nc6 3. Qxf7# 1-0

# Test with real Lichess-style annotation example
query I
SELECT COUNT(*) 
FROM filter_movetext_annotations('1. d4 { [%eval 0.25] [%clk 1:30:43] } Nf6 { [%eval 0.22] [%clk 1:30:42] }')
WHERE filtered_movetext NOT LIKE '%{%';
----
1
