# name: test/sql/read_pgn_parse_errors.test
# description: Test parse_error column for game diagnostics (Spec: data-schema - Parse Error Column)
# group: [read_pgn]

require chess

# Test that parse_error column exists
query IIIIII
DESCRIBE SELECT parse_error FROM read_pgn('test/pgn_files/parse_errors.pgn') LIMIT 1;
----
parse_error	VARCHAR	YES	NULL	NULL	NULL

# Test that all games are returned
query I
SELECT COUNT(*) FROM read_pgn('test/pgn_files/parse_errors.pgn');
----
2

# Test successful games have NULL parse_error (Spec: data-schema - Successful game parsing)
query II
SELECT White, parse_error FROM read_pgn('test/pgn_files/parse_errors.pgn') 
WHERE parse_error IS NULL 
ORDER BY White;
----
Alice	NULL
No one	NULL

# Note: We do not test 'parse_error IS NOT NULL' here because the pgn-reader library 
# is extremely robust and recovers from almost all malformed inputs (returning partial data 
# with no error), making it difficult to generate a synthetic parse error in tests.
# The mechanism is implemented, but effectively unused for common malformed PGNs.

# Deterministic parser-stage failure fixture should produce non-NULL parse_error.
query I
SELECT COUNT(*)
FROM read_pgn('test/pgn_files/parser_stage_error.pgn')
WHERE parse_error IS NOT NULL;
----
1

# Parser-stage diagnostics should include stage, file context, and game index.
query IIII
SELECT
  parse_error LIKE '%Parser-stage error: stage=read_game%',
  parse_error LIKE '%parser_stage_error.pgn%',
  parse_error LIKE '%game_index=1%',
  parse_error LIKE '%unterminated comment%'
FROM read_pgn('test/pgn_files/parser_stage_error.pgn')
LIMIT 1;
----
true	true	true	true

# Parser-stage and conversion diagnostics should be combined in a single parse_error string.
query III
SELECT
  parse_error LIKE '%Conversion error: WhiteElo=%',
  parse_error LIKE '%Conversion error: UTCDate=%',
  parse_error LIKE '%Conversion error: UTCTime=%'
FROM read_pgn('test/pgn_files/parser_stage_error.pgn')
LIMIT 1;
----
true	true	true

# Ingestion should continue to subsequent files in a glob even when one file has a parser-stage error.
query III
SELECT
  COUNT(*),
  COUNT(*) FILTER (WHERE parse_error IS NULL),
  COUNT(*) FILTER (WHERE parse_error IS NOT NULL)
FROM read_pgn('test/pgn_files/parser_stage_*.pgn');
----
2	1	1

query I
SELECT COUNT(*)
FROM read_pgn('test/pgn_files/parser_stage_*.pgn')
WHERE Event = 'Parser Stage Valid Game';
----
1
